stages:
  - test
  - build
  - deploy

test:
  stage: test
  script:
    - echo "Running tests..."
    - if [ -f ./scripts/test.sh ]; then chmod +x ./scripts/test.sh && ./scripts/test.sh; else echo "test.sh not found"; fi
  tags:
    - general

build:
  stage: build
  script:
    - echo "Building application..."
    - if [ -f ./scripts/build.sh ]; then chmod +x ./scripts/build.sh && ./scripts/build.sh; else echo "build.sh not found"; fi
  tags:
    - general

deploy-job:
  stage: deploy
  script:
    - echo "Deploying application..."
    - mkdir -p ~/.ssh
    - echo "$DEPLOY_SSH_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - |
      ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@$EC2_IP <<EOF
      echo "ðŸš€ [Step 1] ì„œë²„ì— ì ‘ì† ì™„ë£Œ, ë°°í¬ë¥¼ ì‹œìž‘í•©ë‹ˆë‹¤."

      # 1. ë°°í¬ ë””ë ‰í† ë¦¬ í™•ì¸ ë° ìƒì„±
      if [ ! -d "/home/ubuntu/S12P11A207" ]; then
        echo "ðŸ“‚ /home/ubuntu/S12P11A207 ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒì„±í•©ë‹ˆë‹¤."
        mkdir -p /home/ubuntu/S12P11A207
      fi

      cd /home/ubuntu/S12P11A207

      # 2. Git Repositoryê°€ ì¡´ìž¬í•˜ëŠ”ì§€ í™•ì¸ í›„ clone ë˜ëŠ” pull ìˆ˜í–‰
      if [ ! -d ".git" ]; then
        echo "ðŸ›  Git ì €ìž¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤. í´ë¡ ì„ ì§„í–‰í•©ë‹ˆë‹¤."
        git clone git@gitlab.com:your-group/S12P11A207.git .
      else
        echo "ðŸ”„ ê¸°ì¡´ ì €ìž¥ì†Œì—ì„œ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸° (git pull)"
        git pull origin master
      fi

      # 3. deploy.sh ì‹¤í–‰ ì—¬ë¶€ ì²´í¬ í›„ ì‹¤í–‰
      if [ -f "./deploy.sh" ]; then
        echo "ðŸš€ Deploy ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘..."
        chmod +x ./deploy.sh
        ./deploy.sh
      else
        echo "ðŸš¨ ERROR: deploy.sh íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
        exit 1
      fi
      EOF
  tags:
    - general
  only:
    - master  # master ë¸Œëžœì¹˜ì—ì„œë§Œ ë°°í¬ ì‹¤í–‰

